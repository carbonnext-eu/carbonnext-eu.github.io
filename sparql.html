<!DOCTYPE html>
<html>

<head>
<title>leaflet-map-simple</title>
</head>

<body>
<form>	
<label>emissionName: <input type="text" id="emissionName"></input></label>
<label>reportingYear: <input type="text" id="reportingYear"></input></label>
<label>latestReport: <input type="checkbox" id="latestReport" checked></input></label>
<button type="button" id="submit"></button>
</form>
<div id="result"></div>


<script>
/* at the end to wait for DOM */

document.getElementById("submit").addEventListener("click", firequery);
document.getElementById("emissionName").value = "CO2, AIR";
document.getElementById("reportingYear").value = "2014";
	
function firequery(){
	var emissionName = document.getElementById("emissionName").value;
	var reportingYear = document.getElementById("reportingYear").value;
	var latestReport = document.getElementById("latestReport").checked;
	console.log(emissionName, reportingYear, latestReport);
	/* query e-prtr with variables */
	var query = makeQueryEPRTR(emissionName, reportingYear, latestReport);
	console.log(query);
	fetch(query)
		.then(function(response) {
		    return response.json();
		}, function(reject){
			console.log(reject);
		})
		.then(myBlob => showEm(myBlob));
}
	
/* use http://semantic.eea.europa.eu/sparql online query tool to generate query */
function makeQueryEPRTR(emissionName = "CO2, AIR", reportingYear = 2014, latestReport=true){
	/* CORS headers not set by europa.eu, so we use a sparql proxy */
	var proxy = "https://cors-anywhere.herokuapp.com/";
	/* easiest sparql endpoint we could find */
	var url = "http://semantic.eea.europa.eu/sparql";
	var query = [
	 "PREFIX eprtr: <http://prtr.ec.europa.eu/rdf/schema.rdf#>",
	 "PREFIX facility: <http://prtr.ec.europa.eu/rdf/facility/>",
	 "PREFIX wgs84: <http://www.w3.org/2003/01/geo/wgs84_pos#>",
	 "select distinct ?facilityName ?hasReport ?quantity ?lat ?long {",
	 "?facility eprtr:facilityName ?facilityName ."];
	/* get the latest values from every facility */
	if(latestReport){
		query.push(
			"?facility eprtr:latestReport ?latestReport .",
			"?pollutantRelease eprtr:facilityReport ?latestReport ."
		);
	/* get the values from facilities for a given year */
	} else {
		query.push(
			"?facility eprtr:hasReport ?hasReport .",
			"?hasReport eprtr:reportingYear "+reportingYear+" .",
			"?pollutantRelease eprtr:facilityReport ?hasReport .",
		);
	}
	query.push(		
	 "?pollutantRelease rdfs:label \""+emissionName+"\" .",
	 "?pollutantRelease eprtr:totalQuantity ?quantity .",
	 "?facility wgs84:lat ?lat .",
	 "?facility wgs84:long ?long .",
	 "}"
	);
	query = query.join(" ");	
	console.log(query);
	return queryUrl = proxy + url + "?query="+ encodeURIComponent(query) +'&format=application%2Fsparql-results%2Bjson';
}


function showEm(data){
	console.log( data );
}

</script>
</body>
</html>
