<!DOCTYPE html>
<html>

<head>
    <title>leaflet-map-simple</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8">

    <!-- Load Leaflet: instructions at http://leafletjs.com/download.html -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.1.0/dist/leaflet.css" integrity="sha384-Zh+y1U8o6/7ni8Mp8szvUfZjGeKKS10CGH3IlD6L1X+XwzYgQ1llOjw/Wslc0cma" crossorigin="anonymous">
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js" integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw==" crossorigin=""></script>
    <!-- Load Omnivore plugin to convert CSV to GeoJSON format -->
    <script src='https://unpkg.com/csv2geojson@5.0.2/csv2geojson.js'></script>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <style>
        @font-face {
            font-family: 'icomoon';
            src: url('fonts/icomoon.svg?akaywm#icomoon') format('svg'),
            url('fonts/icomoon.ttf?akaywm') format('truetype'),
            url('fonts/icomoon.woff?akaywm') format('woff');
            font-weight: normal;
            font-style: normal;
        }
        [class^="icon-"],
        [class*=" icon-"] {
            /* use !important to prevent issues with browser extensions that change fonts */
            font-family: 'icomoon' !important;
            speak: none;
            font-style: normal;
            font-weight: normal;
            font-variant: normal;
            text-transform: none;
            line-height: 1;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .icon-folder-plus:before {
            content: "\e931";
        }
        .icon-folder-minus:before {
            content: "\e932";
        }

        body {
            margin: 0;
            padding: 0;
        }
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            right: 250px;
            left: 0;
        }
        div#layercontrol {
            position: absolute;
            top: 0;
            right: 0;
            width: 250px;
            overflow-y: overlay;
        }
        div[id*="layercontrolSub-"] {
            padding-left: 12px;
            font-size: small;
            display: none;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <div id="layercontrol">
	<div id="layercontrolNoSub"><h3>Consumers</h3></div>
	<div id="layercontrolSub"><h3>Emitters</h3></div>
    </div>

    <script>
        jQuery.propHooks.checked = {
            set: function(el, value) {
                el.checked = value;
                $(el)
                    .trigger('change');
            }
        };
        /* Set up the map with initial center and zoom level */
        var map = L.map('map', {
            center: [51.65892, 6.41601], // EDIT latitude, longitude to re-center map
            zoom: 5, // EDIT from 1 to 18 -- decrease to zoom out, increase to zoom in
            scrollWheelZoom: false
        });
        /* Carto light-gray basemap tiles with labels */
        var light = L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>, &copy; <a href="https://carto.com/attribution">CARTO</a>'
            })
            .addTo(map);

	/* Load all csv data files and create menu*/
        getEmissionData('CO', 'CO.csv', "#004e83");
        getEmissionData('CO2', 'CO2.csv', "#008D4D");
	getChemparkData('Chemical parks', 'chemicalparks.csv', "#CC7300");

        function getEmissionData(emName, file, color) {
	    fetch(file)
		.then(function(response) {
		    return response.text();
		})
		.then(myBlob => convertCSV(myBlob))
		.then(geojson => addEmissionsToMap(geojson, color))
		.then(dataLayer => addEmissionsToMenu(dataLayer, emName));
        };
	    
	function getChemparkData(name, file, color) {
	    fetch(file)
		.then(function(response) {
		    return response.text();
		})
		.then(myBlob => convertCSV(myBlob))
		.then(geojson => addParksToMap(geojson, color))
		.then(dataLayer => addParksToMenu(dataLayer, name));
        };   

        function convertCSV(myBlob) {
		return new Promise(function(resolve, reject) {
			csv2geojson.csv2geojson(myBlob, {
				latfield: 'latitude',
				lonfield: 'longitude',
				delimiter: ';',
			}, function(err, geojson){
				if (err){
					console.error(err);
					reject(err);
				}
				else {
					resolve(geojson);
				}
			});
		});
	};

	function addParksToMap(geojson, color) {
	    return new Promise(function(resolve, reject) {
		    var dataLayer = L.geoJSON(geojson, {
			pointToLayer: function(feature, latlon) {
			    // L.circleMarker() draws a circle with fixed radius in pixels.
			    // To draw a circle overlay with a radius in meters, use L.circle()
			    return L.circleMarker(latlon, {
				color: color,
				weight: 0,
				radius: 10
			    });
			},
			onEachFeature: function(feature, layer) {
			    layer.bindPopup(feature.properties.FacilityName);
			}
		    });
		    resolve(dataLayer);
	    });
        }
	    
	function addParksToMenu(dataLayer, name){
		var escName = name.replace(" ", "_");
		$('div#layercontrolNoSub')
			.append($('<label><input type="checkbox" class="' + escName + '" id="' + escName + 'checkbAll">' + name + '</label><br>'));
		    $('div#layercontrolNoSub input[type="checkbox"].' + escName)
			.on('change', function() {
			    if ($(this).is(':checked')) {
				    map.addLayer(dataLayer);
			    } else {
				    map.removeLayer(dataLayer);
			    }
                 });	
	}
	    
        function addEmissionsToMap(geojson, color) {
	    return new Promise(function(resolve, reject) {
		    var layers = {};
		    var max = Math.max.apply(Math, geojson.features.map(function(o) {
			return o.properties.MTonnes;
		    }));
		    var min = Math.min.apply(Math, geojson.features.map(function(o) {
			return o.properties.MTonnes;
		    }));

		    var dataLayer = L.geoJSON(geojson, {
			pointToLayer: function(feature, latlon) {
			    // L.circleMarker() draws a circle with fixed radius in pixels.
			    // To draw a circle overlay with a radius in meters, use L.circle()
			    return L.circleMarker(latlon, {
				color: color,
				weight: 0,
				radius: (Math.sqrt((feature.properties.MTonnes - min) / (max - min)) * 50 + 1)
			    });
			},
			onEachFeature: function(feature, layer) {
			    feature.properties.NACEMainEconomicActivityName = feature.properties.NACEMainEconomicActivityName.replace("'", "&#39;");
			    if (layers[feature.properties.NACEMainEconomicActivityName] == undefined) {
				layers[feature.properties.NACEMainEconomicActivityName] = {
				    layer: new L.LayerGroup(),
				    total: 0,
				    count: 0
				};
			    }
			    layers[feature.properties.NACEMainEconomicActivityName].layer.addLayer(layer);
			    layers[feature.properties.NACEMainEconomicActivityName].total += parseFloat(feature.properties.MTonnes);
			    layers[feature.properties.NACEMainEconomicActivityName].count += 1;
			    layer.bindPopup(feature.properties.FacilityName + '<br />' + feature.properties.NACEMainEconomicActivityName + '<br />' + feature.properties.MTonnes + ' Mt ' + emName);
			}
		    });
		    resolve(layers);
	    });
        }

        function addEmissionsToMenu(layers, emName) { 
	    $('div#layercontrolSub')
                .append($('<span id="' + emName + 'togglebutton" class="icon-folder-plus"></span><label><input type="checkbox" class="' + emName + '" id="' + emName + 'checkbAll">' + emName + '</label><br>'));
            $('#' + emName + 'togglebutton').on('click', function() {
                    if ($(this).hasClass('icon-folder-plus')) {
                        $(this).removeClass('icon-folder-plus').addClass('icon-folder-minus');
                        $('div#layercontrolSub-' + emName).show();
                    } else {
                        $(this).removeClass('icon-folder-minus').addClass('icon-folder-plus');
                        $('div#layercontrolSub-' + emName).hide();
                    }
                });
            $('div#layercontrolSub').append($('<div id="layercontrolSub-' + emName + '">'));
            var i = 1;
            var keysSorted = Object.keys(layers).sort(function(a, b) {
                    return layers[b].total - layers[a].total
                });
            for (layerName in keysSorted) {
                $('div#layercontrolSub-' + emName)
                    .append($('<label><input type="checkbox" data-layer=\'' + keysSorted[layerName] + '\' class="' + emName + '">' + keysSorted[layerName] + ' (' + layers[keysSorted[layerName]].total.toFixed(2) + '&nbsp;Mt, ' + layers[keysSorted[layerName]].count + ')</label><br>'));
                i = i + 1;
            }
            $('div#layercontrolSub input[type="checkbox"].' + emName)
                .on('change', function() {
                    if ($(this).is(':checked')) {
                        if (this.id == emName + "checkbAll") {
                            $('div#layercontrolSub-' + emName + ' input[type="checkbox"]').prop("checked", true);
                        } else {
                            map.addLayer(layers[$(this).attr('data-layer').replace("'", "&#39;")].layer);
                        }
                    } else {
                        if (this.id == emName + "checkbAll") {
                            $('div#layercontrolSub-' + emName + ' input[type="checkbox"]').prop("checked", false);
                        } else {
                            map.removeLayer(layers[$(this).attr('data-layer').replace("'", "&#39;")].layer);
                        }
                    }
                });
        }

        map.on('focus', () => {
            map.scrollWheelZoom.enable();
        });
        map.on('blur', () => {
            map.scrollWheelZoom.disable();
        });
    </script>
</body>

</html>
