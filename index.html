<!DOCTYPE html>
<html>
<head>
  <title>leaflet-map-simple</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="utf-8">

  <!-- Load Leaflet: instructions at http://leafletjs.com/download.html -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.1.0/dist/leaflet.css"
  integrity="sha384-Zh+y1U8o6/7ni8Mp8szvUfZjGeKKS10CGH3IlD6L1X+XwzYgQ1llOjw/Wslc0cma"
  crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-dvf/0.3.1/css/dvf.css" integrity="sha256-Nd2GYmWjQVljoYgRUP2AWWniAYagCg1k7QhXa9N1kLg=" crossorigin="anonymous" />
  
  <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
  integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
  crossorigin=""></script>
  <!-- Load Omnivore plugin to convert CSV to GeoJSON format -->
  <script src='https://unpkg.com/csv2geojson@5.0.2/csv2geojson.js'></script>
  <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
			  crossorigin="anonymous"></script>
  <!-- Position the map and title with Cascading Style Sheet (.css) -->
  <style>
  body { margin:0; padding:0; }
  #map { position: absolute; top:0; bottom:0; right:0; left:0; }
  #map-title { position: relative; margin-top: 10px; margin-left: 50px; float: left; background: white; border: 2px solid rgba(0,0,0,0.2); padding: 6px 8px; font-family: Helvetica; font-weight: bold; font-size: 24px; z-index: 800; }
  div#layercontrol {position: absolute;top: 0; left: 0; z-index:9999;}
  div#layercontrolCO {padding-left:6px;}
  </style>
</head>
<body>

  <!-- Display the map and title with HTML division tags  -->
  <div id="map-title">oh test</div>
  <div id="map"></div>
  <div id="layercontrol" class="leaflet-right leaflet-top">
  </div>

  <!-- Create the map content with JavaScript (.js) -->
  <script>
/* Set up the map with initial center and zoom level */
var map = L.map('map', {
    center: [50.1218292, 8.5995234], // EDIT latitude, longitude to re-center map
    zoom: 6, // EDIT from 1 to 18 -- decrease to zoom out, increase to zoom in
    scrollWheelZoom: false
});

/* Control panel to display map layers */
var controlLayers = L.control.layers(null, null, {
    position: "topright",
    collapsed: false
}).addTo(map);

/* Carto light-gray basemap tiles with labels */
var light = L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>, &copy; <a href="https://carto.com/attribution">CARTO</a>'
}).addTo(map);

var dataLayer;
var layers = {};
$.ajax('CO.csv', {
    error: function(xhr,status,error){
	    console.log(status,error);
    },
    success: function(data) {
        csv2geojson.csv2geojson(data, {
            latfield: 'latitude',
            lonfield: 'longitude',
            delimiter: ';',
        }, function(err, geojson) {
		var max = Math.max.apply(Math,geojson.features.map(function(o){return o.properties.MTonnes;}));
		var min = Math.min.apply(Math,geojson.features.map(function(o){return o.properties.MTonnes;}));
		console.log(min, max);
		
		dataLayer = L.geoJSON(geojson, {
		    pointToLayer: function(feature, latlon) {
			// L.circleMarker() draws a circle with fixed radius in pixels. 
			// To draw a circle overlay with a radius in meters, use L.circle()
			if(feature.properties.MTonnes>min + (max-min)*0.02){
			  return L.circleMarker(latlon, {weight: 0, radius: ((feature.properties.MTonnes-min)/(max-min)*50+1)});
			}
		    },
		    onEachFeature: function(feature, layer) {
			    if (layers[feature.properties.NACEMainEconomicActivityName] == undefined){
				  layers[feature.properties.NACEMainEconomicActivityName] = new L.LayerGroup();
				  
			    }
			    layers[feature.properties.NACEMainEconomicActivityName].addLayer(layer);
		    }
		});
		console.log(layers);
		$('div#layercontrol').append($('<label><input type="checkbox" data-layer="CO">CO</label><br>'));
		$('div#layercontrol').append($('<div id="layercontrolCO">'));
		for(layer in layers){
			$('div#layercontrolCO').append($('<label><input type="checkbox" data-layer="'+layer+'">'+layer+'</label><br>'));
			$('div#layercontrol input[type="checkbox"]').on('click', function() {    
			    var checkbox = $(this);
			    var layer = checkbox.data().layer; 
			    // toggle the layer
			    if (checkbox.is(':checked')) {
				if(layer=="CO"){
					map.addLayer(layers);
				}
				else {
					map.addLayer(layer);
				}
			    } else {
				if(layer=="CO"){
					map.removeLayer(layers);
				}
				map.removeLayer(layer);
			    }
			});
		}
		
        });
    }
});

map.on('focus', () => {
    map.scrollWheelZoom.enable();
});
map.on('blur', () => {
    map.scrollWheelZoom.disable();
});
  </script>
</body>
</html>
