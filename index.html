<!DOCTYPE html>
<html>

<head>
    <title>leaflet-map-simple</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8">

    <!-- Load Leaflet: instructions at http://leafletjs.com/download.html -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.1.0/dist/leaflet.css" integrity="sha384-Zh+y1U8o6/7ni8Mp8szvUfZjGeKKS10CGH3IlD6L1X+XwzYgQ1llOjw/Wslc0cma" crossorigin="anonymous">
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js" integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw==" crossorigin=""></script>
    <!-- Load Omnivore plugin to convert CSV to GeoJSON format -->
    <script src='https://unpkg.com/csv2geojson@5.0.2/csv2geojson.js'></script>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <style>
        .icon {
	  display: inline-block;
	  width: 1em;
	  height: 1em;
	  stroke-width: 0;
	  stroke: currentColor;
	  fill: currentColor;
	}

        body {
            margin: 0;
            padding: 0;
        }
	h3 {
		margin-bottom:2px;
		padding-bottom:0px;
	}
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            right: 0;
            left: 0;
        }
        div#layercontrol {
            position: absolute;
            top: 5px;
            right: 5px;
	    bottom: 15px;
            width: 250px;
	    padding: 3px;
	    background-color: rgba(226, 238, 246,0.7);
	    border-radius: 5px;
	    border: 1px solid rgba(0,78,131,0.9);
            overflow-y: overlay;
	    z-index: 7000;
        }
	#layercontrolMinimize {
	    position: absolute;
	    top: 50%;
	    left: -8px;
	    margin-top: -8px;
	    z-index: 8000;
	    border: 1px solid rgba(0,78,131,0.9);
	    background-color: rgb(226, 238, 246);
	}
	#layercontrolMinimize svg {
	    position:absolute;
	    top:50%;
	    bottom:50%;
	    transform:translate(-50%, -50%);
	}
        div[id*="layercontrolSub-"] {
            padding-left: 12px;
            font-size: small;
            display: none;
        }
    </style>
</head>

<body>
<svg aria-hidden="true" style="position: absolute; width: 0; height: 0; overflow: hidden;" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<defs>
<symbol id="icon-folder-plus" viewBox="0 0 32 32">
<title>folder-plus</title>
<path d="M18 8l-4-4h-14v26h32v-22h-14zM22 22h-4v4h-4v-4h-4v-4h4v-4h4v4h4v4z"></path>
</symbol>
<symbol id="icon-folder-minus" viewBox="0 0 32 32">
<title>folder-minus</title>
<path d="M18 8l-4-4h-14v26h32v-22h-14zM22 22h-12v-4h12v4z"></path>
</symbol>
<symbol id="icon-play3" viewBox="0 0 32 32">
<title>play3</title>
<path d="M6 4l20 12-20 12z"></path>
</symbol>
</defs>
</svg>

    <div id="map"></div>
    <div id="layercontrol">
	<div id="layercontrolNoSub"><h3>Consumers</h3></div>
	<div id="layercontrolSub"><h3>Emitters</h3></div>
	<span id="layercontrolMinimize" data-minimized="false">
		<svg class="icon icon-play3"><use xlink:href="#icon-play3"></use></svg>
	</span>
    </div>

    <script>
        jQuery.propHooks.checked = {
            set: function(el, value) {
                el.checked = value;
                $(el)
                    .trigger('change');
            }
        };
        /* Set up the map with initial center and zoom level */
        var map = L.map('map', {
            center: [51.65892, 6.41601], // EDIT latitude, longitude to re-center map
            zoom: 5, // EDIT from 1 to 18 -- decrease to zoom out, increase to zoom in
            scrollWheelZoom: false
        });
        /* Carto light-gray basemap tiles with labels */
        var light = L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>, &copy; <a href="https://carto.com/attribution">CARTO</a>'
            })
            .addTo(map);
	    
	$('#layercontrolMinimize').on('click', function() {
		console.log($(this));
		if($(this).data("minimized")){
			$(this).data("minimized", false);
			$('#layercontrol').css({'width': "250px", transform: "rotate(180deg)"});
		} else {
			$(this).data("minimized", true);
			$('#layercontrol').css({'width': "20px", transform: "rotate(0deg)"});
			
		}
	});

	/* Load all csv data files and create menu*/
        getEmissionData('CO', 'CO.csv', "#004e83");
        getEmissionData('CO2', 'CO2.csv', "#008D4D");
	getChemparkData('Chemical parks', 'chemicalparks.csv', "#CC7300");

        function getEmissionData(emName, file, color) {
	    fetch(file)
		.then(function(response) {
		    return response.text();
		})
		.then(myBlob => convertCSV(myBlob))
		.then(geojson => addEmissionsToMap(geojson, emName, color))
		.then(dataLayer => addEmissionsToMenu(dataLayer, emName));
        };
	    
	function getChemparkData(name, file, color) {
	    fetch(file)
		.then(function(response) {
		    return response.text();
		})
		.then(myBlob => convertCSV(myBlob))
		.then(geojson => addParksToMap(geojson, color))
		.then(dataLayer => addParksToMenu(dataLayer, name));
        };   

        function convertCSV(myBlob) {
		return new Promise(function(resolve, reject) {
			csv2geojson.csv2geojson(myBlob, {
				latfield: 'latitude',
				lonfield: 'longitude',
				delimiter: ';',
			}, function(err, geojson){
				if (err){
					console.error(err);
					reject(err);
				}
				else {
					resolve(geojson);
				}
			});
		});
	};

	function addParksToMap(geojson, color) {
	    return new Promise(function(resolve, reject) {
		    var dataLayer = L.geoJSON(geojson, {
			pointToLayer: function(feature, latlon) {
			    // L.circleMarker() draws a circle with fixed radius in pixels.
			    // To draw a circle overlay with a radius in meters, use L.circle()
			    return L.circleMarker(latlon, {
				color: color,
				weight: 0,
				radius: 10
			    });
			},
			onEachFeature: function(feature, layer) {
			    layer.bindPopup(feature.properties.FacilityName);
			}
		    });
		    resolve(dataLayer);
	    });
        }
	    
	function addParksToMenu(dataLayer, name){
		var escName = name.replace(" ", "_");
		$('div#layercontrolNoSub')
			.append($('<label><input type="checkbox" class="' + escName + '" id="' + escName + 'checkbAll">' + name + '</label><br>'));
		    $('div#layercontrolNoSub input[type="checkbox"].' + escName)
			.on('change', function() {
			    if ($(this).is(':checked')) {
				    map.addLayer(dataLayer);
			    } else {
				    map.removeLayer(dataLayer);
			    }
                 });	
	}
	    
        function addEmissionsToMap(geojson, emName, color) {
	    return new Promise(function(resolve, reject) {
		    var layers = {};
		    var max = Math.max.apply(Math, geojson.features.map(function(o) {
			return o.properties.MTonnes;
		    }));
		    var min = Math.min.apply(Math, geojson.features.map(function(o) {
			return o.properties.MTonnes;
		    }));

		    var dataLayer = L.geoJSON(geojson, {
			pointToLayer: function(feature, latlon) {
			    // L.circleMarker() draws a circle with fixed radius in pixels.
			    // To draw a circle overlay with a radius in meters, use L.circle()
			    return L.circleMarker(latlon, {
				color: color,
				weight: 0,
				radius: (Math.sqrt((feature.properties.MTonnes - min) / (max - min)) * 50 + 1)
			    });
			},
			onEachFeature: function(feature, layer) {
			    feature.properties.NACEMainEconomicActivityName = feature.properties.NACEMainEconomicActivityName.replace("'", "&#39;");
			    if (layers[feature.properties.NACEMainEconomicActivityName] == undefined) {
				layers[feature.properties.NACEMainEconomicActivityName] = {
				    layer: new L.LayerGroup(),
				    total: 0,
				    count: 0
				};
			    }
			    layers[feature.properties.NACEMainEconomicActivityName].layer.addLayer(layer);
			    layers[feature.properties.NACEMainEconomicActivityName].total += parseFloat(feature.properties.MTonnes);
			    layers[feature.properties.NACEMainEconomicActivityName].count += 1;
			    layer.bindPopup(feature.properties.FacilityName + '<br />' + feature.properties.NACEMainEconomicActivityName + '<br />' + feature.properties.MTonnes + ' Mt ' + emName);
			}
		    });
		    resolve(layers);
	    });
        }

        function addEmissionsToMenu(layers, emName) { 
	    $('div#layercontrolSub')
                .append($('<svg class="icon icon-folder-plus" id="' + emName + 'togglebutton"><use xlink:href="#icon-folder-plus"></use></svg><label><input type="checkbox" class="' + emName + '" id="' + emName + 'checkbAll">' + emName + '</label><br>'));
            $('#' + emName + 'togglebutton').on('click', function() {
                    if ($(this).hasClass('icon-folder-plus')) {
                        $(this).removeClass('icon-folder-plus').addClass('icon-folder-minus');
			$("use", this).attr("xlink:href", "#icon-folder-minus");
                        $('div#layercontrolSub-' + emName).show();
                    } else {
                        $(this).removeClass('icon-folder-minus').addClass('icon-folder-plus');
			$("use", this).attr("xlink:href", "#icon-folder-plus");
                        $('div#layercontrolSub-' + emName).hide();
                    }
                });
            $('div#layercontrolSub').append($('<div id="layercontrolSub-' + emName + '">'));
            var i = 1;
            var keysSorted = Object.keys(layers).sort(function(a, b) {
                    return layers[b].total - layers[a].total
                });
            for (layerName in keysSorted) {
                $('div#layercontrolSub-' + emName)
                    .append($('<label><input type="checkbox" data-layer=\'' + keysSorted[layerName] + '\' class="' + emName + '">' + keysSorted[layerName] + ' (' + layers[keysSorted[layerName]].total.toFixed(2) + '&nbsp;Mt, ' + layers[keysSorted[layerName]].count + ')</label><br>'));
                i = i + 1;
            }
            $('div#layercontrolSub input[type="checkbox"].' + emName)
                .on('change', function() {
                    if ($(this).is(':checked')) {
                        if (this.id == emName + "checkbAll") {
                            $('div#layercontrolSub-' + emName + ' input[type="checkbox"]').prop("checked", true);
                        } else {
                            map.addLayer(layers[$(this).attr('data-layer').replace("'", "&#39;")].layer);
                        }
                    } else {
                        if (this.id == emName + "checkbAll") {
                            $('div#layercontrolSub-' + emName + ' input[type="checkbox"]').prop("checked", false);
                        } else {
                            map.removeLayer(layers[$(this).attr('data-layer').replace("'", "&#39;")].layer);
                        }
                    }
                });
        }

        map.on('focus', () => {
            map.scrollWheelZoom.enable();
        });
        map.on('blur', () => {
            map.scrollWheelZoom.disable();
        });
    </script>
</body>

</html>
